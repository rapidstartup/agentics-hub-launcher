<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lovable Data Export Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover:not(:disabled) {
            background: #059669;
        }
        button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status.info {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        .status.success {
            background: #f0fdf4;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .status.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .warning {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .table-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .table-card {
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        .table-card.success {
            background: #f0fdf4;
            border-color: #10b981;
        }
        .table-card.empty {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .table-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }
        .table-count {
            color: #6b7280;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Lovable Cloud Data Export Tool</h1>
        <p class="subtitle">Export your data from Lovable Cloud Supabase</p>

        <div class="warning">
            <strong>⚠️ Important:</strong> You must be logged into your Lovable Cloud application in another tab/window for this to work. This tool uses your authenticated session to bypass RLS policies.
        </div>

        <div class="section">
            <div class="section-title">Step 1: Configure Connection</div>
            <label>
                <strong>Supabase URL</strong>
                <input type="text" id="supabaseUrl" value="https://pooeaxqkysmngpnpnswn.supabase.co" placeholder="https://xxx.supabase.co">
            </label>
            <br><br>
            <label>
                <strong>Anon Key</strong>
                <input type="text" id="anonKey" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBvb2VheHFreXNtbmdwbnBuc3duIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNTk3ODgsImV4cCI6MjA3NjgzNTc4OH0.Tx38u656P8LUvpQCH5rp6d5flDtV_f9_vsMEn8cr4FI" placeholder="eyJ...">
            </label>
            <br><br>
            <label>
                <strong>Auth Token (from your browser session)</strong>
                <input type="text" id="authToken" placeholder="eyJ... (get this from browser DevTools)">
            </label>
            <br><br>
            <button onclick="testConnection()">Test Connection</button>
        </div>

        <div class="section">
            <div class="section-title">Step 2: Export Data</div>
            <button id="exportBtn" onclick="exportAllData()" disabled>Export All Tables</button>
        </div>

        <div id="status"></div>
        <div id="tableResults" class="table-results"></div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const TABLES = [
            'agent_configs',
            'agent_messages',
            'clients',
            'knowledge_base_items',
            'market_research_reports',
            'n8n_connections',
            'project_agents',
            'project_asset_statuses',
            'project_tasks',
            'projects'
        ];

        let supabaseClient = null;

        function log(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            statusDiv.innerHTML = `<div class="status ${className}">${message}</div>`;
        }

        async function testConnection() {
            const url = document.getElementById('supabaseUrl').value;
            const anonKey = document.getElementById('anonKey').value;
            const authToken = document.getElementById('authToken').value;

            if (!url || !anonKey) {
                log('Please provide Supabase URL and Anon Key', 'error');
                return;
            }

            log('Testing connection...');

            try {
                // Create client with anon key
                const options = {
                    auth: {
                        autoRefreshToken: false,
                        persistSession: false,
                    }
                };

                // If auth token provided, add it to headers
                if (authToken) {
                    options.global = {
                        headers: {
                            Authorization: `Bearer ${authToken}`
                        }
                    };
                }

                supabaseClient = supabase.createClient(url, anonKey, options);

                // Test by trying to fetch from a table
                const { data, error, count } = await supabaseClient
                    .from('agent_configs')
                    .select('*', { count: 'exact' })
                    .limit(1);

                if (error) {
                    log(`Connection test failed: ${error.message}`, 'error');
                    return;
                }

                log(`✓ Connection successful!\nFound ${count} rows in agent_configs table.\n\n${authToken ? 'Using authenticated session.' : 'Using anonymous access (may be limited by RLS).'}`, 'success');
                document.getElementById('exportBtn').disabled = false;

            } catch (error) {
                log(`Connection error: ${error.message}`, 'error');
            }
        }

        async function exportAllData() {
            if (!supabaseClient) {
                log('Please test connection first', 'error');
                return;
            }

            const exportBtn = document.getElementById('exportBtn');
            exportBtn.disabled = true;
            exportBtn.textContent = 'Exporting...';

            log('Starting export of all tables...');

            const allData = {};
            const stats = {};
            const tableResultsDiv = document.getElementById('tableResults');
            tableResultsDiv.innerHTML = '';

            for (const tableName of TABLES) {
                try {
                    log(`Exporting ${tableName}...`);

                    let allRows = [];
                    let page = 0;
                    const pageSize = 1000;

                    while (true) {
                        const { data, error, count } = await supabaseClient
                            .from(tableName)
                            .select('*', { count: 'exact' })
                            .range(page * pageSize, (page + 1) * pageSize - 1);

                        if (error) {
                            console.error(`Error fetching ${tableName}:`, error);
                            stats[tableName] = { rows: 0, error: error.message };
                            break;
                        }

                        if (!data || data.length === 0) {
                            break;
                        }

                        allRows = allRows.concat(data);

                        if (data.length < pageSize) {
                            break;
                        }

                        page++;
                    }

                    allData[tableName] = allRows;
                    stats[tableName] = { rows: allRows.length };

                    // Update UI
                    const card = document.createElement('div');
                    card.className = `table-card ${allRows.length > 0 ? 'success' : 'empty'}`;
                    card.innerHTML = `
                        <div class="table-name">${tableName}</div>
                        <div class="table-count">${allRows.length} rows</div>
                    `;
                    tableResultsDiv.appendChild(card);

                } catch (error) {
                    console.error(`Failed to export ${tableName}:`, error);
                    stats[tableName] = { rows: 0, error: error.message };
                }
            }

            // Calculate totals
            const totalRows = Object.values(allData).reduce((sum, arr) => sum + arr.length, 0);

            // Create download
            const exportData = {
                exported_at: new Date().toISOString(),
                total_rows: totalRows,
                stats: stats,
                data: allData
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = `lovable-export-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(downloadUrl);

            log(`✓ Export complete!\n\nTotal rows: ${totalRows}\n\nFile downloaded: lovable-export-${Date.now()}.json\n\nYou can now import this file using:\nnpx tsx scripts/import-from-backup.ts`, 'success');

            exportBtn.disabled = false;
            exportBtn.textContent = 'Export All Tables';
        }

        // Try to auto-detect auth token from localStorage
        window.addEventListener('load', () => {
            try {
                const keys = Object.keys(localStorage).filter(k => k.includes('supabase') && k.includes('auth'));
                if (keys.length > 0) {
                    const authData = JSON.parse(localStorage.getItem(keys[0]));
                    if (authData?.access_token) {
                        document.getElementById('authToken').value = authData.access_token;
                        log('Auto-detected auth token from localStorage. Click "Test Connection" to verify.', 'info');
                    }
                }
            } catch (e) {
                // Ignore errors
            }
        });
    </script>
</body>
</html>
